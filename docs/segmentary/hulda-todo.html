<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"><!-- for emoji happiness-->
    <link rel='stylesheet'
        href='https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/css/calcite-web.min.css'>

    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.0-beta.76/calcite.esm.js"></script>
    <script nomodule="" src="https://js.arcgis.com/calcite-components/1.0.0-beta.76/calcite.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.0-beta.76/calcite.css" />

    <link href="https://unpkg.com/tabulator-tables@5.1/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.1/dist/js/tabulator.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body {
            padding: 1em;
        }

        calcite-button {
            padding: 0.15em
        }
    </style>
</head>

<body>
    <h1>Hulda Segments To Run</h1>

    <div>
        <calcite-button appearance="solid" id="button1">Compare Bjorn and Chris</calcite-button>
        <calcite-button appearance="solid" id="button2">Compare Bjorn and Kylie</calcite-button>
        <calcite-button appearance="solid" id="button3">Compare Bjorn and Erwin</calcite-button>
        <calcite-button appearance="solid" id="button4">Compare Kylie and Chris</calcite-button>
        <calcite-button appearance="solid" id="button5">Compare Bjorn and Zara</calcite-button>
        <calcite-button appearance="solid" id="button11">Bjorn</calcite-button>
        <calcite-button appearance="solid" id="button12">Chris</calcite-button>
        <calcite-button appearance="solid" id="button13">Kylie</calcite-button>
        <calcite-button appearance="solid" id="button14">Zara</calcite-button>
        <calcite-button appearance="solid" id="button25">Bjorn but not Kylie</calcite-button>
        <calcite-button appearance="solid" id="button26">Kylie but not Bjorn</calcite-button>
    </div>

    <div id="description" style="padding-top:1em"></div>

    <ol id="segmentListing">
    </ol>

    <p id="intro">
        Map coming soon-ish...
    </p>

    <script>
        (async () => {

            const descriptionDiv = document.getElementById('description');
            const segmentListingElement = document.getElementById('segmentListing');
            const areaname = "Hulda";

            const segmURL = areaname.toLocaleLowerCase() + "-segments.json"
            const athlURL = areaname.toLocaleLowerCase() + "-athletes.json"
            let segmentData = [];
            let athleteData = [];

            const href = window.location.href;
            const pageURL = new URL(href);
            const initialRunner = pageURL.searchParams.get("runner") || "1167695";
            const initialRunners = pageURL.searchParams.get("runners") || false;

            document.getElementById("button11").addEventListener("click", function () {
                personalSegmentsTodo('1167695'); // Bjorn
            });
            document.getElementById("button12").addEventListener("click", function () {
                personalSegmentsTodo('294207'); // Chris
            });
            document.getElementById("button13").addEventListener("click", function () {
                personalSegmentsTodo('6260742'); // Kylie
            });
            document.getElementById("button14").addEventListener("click", function () {
                personalSegmentsTodo('23099564'); // Zara
            });

            document.getElementById("button1").addEventListener("click", function () {
                getCommonSegmentsTodo('294207', '1167695');
            });
            document.getElementById("button2").addEventListener("click", function () {
                getCommonSegmentsTodo('6260742', '1167695');
            });
            document.getElementById("button3").addEventListener("click", function () {
                getCommonSegmentsTodo('16638771', '1167695'); // erwin 16638771
            });
            document.getElementById("button4").addEventListener("click", function () {
                getCommonSegmentsTodo('294207', '6260742');
            });
            document.getElementById("button5").addEventListener("click", function () {
                getCommonSegmentsTodo('1167695', '23099564'); // bjorn and zara
            });
            document.getElementById("button25").addEventListener("click", function () {
                getUniqueSegmentsTodo('1167695', '6260742'); // bjorn but not kylie
            });
            document.getElementById("button26").addEventListener("click", function () {
                getUniqueSegmentsTodo('6260742', '1167695'); // kylie but not bjorn
            });

            // grab the available HTML file names
            await axios.get(segmURL)
                .then(function (response) {
                    segmentData = response.data; // .body ; //JSON.parse(response.body);
                    segmentData.forEach((element, index) => {
                        if (element.name.match(/&#39;/)) {
                            element.name = element.name.replace(/&#39;/gi, "'");
                        }
                    });
                })
                .catch(function (error) {
                    console.error("-------- error 101 ----------");
                    console.error(error);
                })
                .then(function () {
                    console.log(`~~~~~~~~~~~~~~~~ got data for ${segmentData.length} segments.`)
                    segmentData.sort((a, b) => {
                        return a['peopleCount'] - b['peopleCount'];  // highest first
                    });

                });
            // end of axiom

            await axios.get(athlURL)
                .then(function (response) {
                    athleteData = response.data;
                    athleteData.forEach((element, index) => {
                        if (element.name.match(/&#39;/)) {
                            element.name = element.name.replace(/&#39;/gi, "'");
                        }
                    });
                })
                .catch(function (error) {
                    console.error("-------- error 102 ----------");
                    console.error(error);
                })
                .then(function () {
                    console.log(`~~~~~~~~~~~~~~~~ got data for ${athleteData.length} athletes.`);
                });
            // end of axiom

            function personalSegmentsTodo(runner) {
                let segmentsLeft = segmentData.filter(seg => !seg.athletes.includes(runner))
                descriptionDiv.innerHTML = `${segmentsLeft.length} segments that <a href="https://www.strava.com/athletes/{${runner}">${athleteData.find(element => element.id == runner).name}</a>
                 have not yet run in <b>${areaname}</b> area:`;

                document.getElementById("segmentListing").innerHTML = "";
                for (var i = 0; i < segmentsLeft.length; i++) {
                    const fact = `<a href="https://www.strava.com/segments/${segmentsLeft[i].segment}">${segmentsLeft[i].name}</a>
                    -- ${segmentsLeft[i].distance} miles long, ran by ${segmentsLeft[i].peopleCount} other runners.`;
                    const newDiv2 = document.createElement("li");
                    newDiv2.innerHTML = fact;
                    segmentListingElement.prepend(newDiv2);
                }
                // This will create a new entry in the browser's history, without reloading
                window.history.pushState({}, '', `?runner=${runner}`);
            } // end of personalSegmentsTodo

            function getUniqueSegmentsTodo(runner1, runner2) {
                document.getElementById("segmentListing").innerHTML = "";
                const segmentsLeft = segmentData.filter(seg => !seg.athletes.includes(runner1) && seg.athletes.includes(runner2))
                descriptionDiv.innerHTML = `<a href="https://www.strava.com/athletes/{${runner1}">${athleteData.find(element => element.id == runner1).name}</a>
                has ${segmentsLeft.length} segments left to run, that <a href="https://www.strava.com/athletes/{${runner2}">${athleteData.find(element => element.id == runner2).name}</a> have already run.`;
                for (var i = 0; i < segmentsLeft.length; i++) {
                    const fact = `<a href="https://www.strava.com/segments/${segmentsLeft[i].segment}">${segmentsLeft[i].name}</a>
                    -- ${segmentsLeft[i].distance} miles long, ran by ${segmentsLeft[i].peopleCount} other runners.`;
                    const newDiv2 = document.createElement("li");
                    newDiv2.innerHTML = fact;
                    segmentListingElement.prepend(newDiv2);
                }
                window.history.pushState({}, '', `?runners=${runner1}|${runner2}`);
            }

            function getCommonSegmentsTodo(runner1, runner2) {
                document.getElementById("segmentListing").innerHTML = "";
                const commonSegmentsLeft = segmentData.filter(seg => !seg.athletes.includes(runner1) && !seg.athletes.includes(runner2))
                descriptionDiv.innerHTML = `Comparing <a href="https://www.strava.com/athletes/{${runner1}">${athleteData.find(element => element.id == runner1).name}</a>
                and <a href="https://www.strava.com/athletes/{${runner2}">${athleteData.find(element => element.id == runner2).name}</a> in <b>${areaname}</b> area.
                <br><br>There are ${commonSegmentsLeft.length} segments that neither have run:`;
                for (var i = 0; i < commonSegmentsLeft.length; i++) {
                    const fact = `<a href="https://www.strava.com/segments/${commonSegmentsLeft[i].segment}">${commonSegmentsLeft[i].name}</a>
                    -- ${commonSegmentsLeft[i].distance} miles long, ran by ${commonSegmentsLeft[i].peopleCount} other runners.`;
                    const newDiv2 = document.createElement("li");
                    newDiv2.innerHTML = fact;
                    segmentListingElement.prepend(newDiv2);
                }
                // This will create a new entry in the browser's history, without reloading
                window.history.pushState({}, '', `?runners=${runner1},${runner2}`);
            } // end of getCommonSegmentsTodo

            // everything setup, time to run something
            if (initialRunners && initialRunners.match(/,/)) {
                let [runnerId1, runnerId2] = initialRunners.split(',');
                getCommonSegmentsTodo(runnerId1, runnerId2);
            } else if (initialRunners && initialRunners.match(/|/)) {
                let [runnerId1, runnerId2] = initialRunners.split('|');
                getUniqueSegmentsTodo(runnerId1, runnerId2);
            } else {
                personalSegmentsTodo(initialRunner);
            }
        })(); // end main async
    </script>
</body>

</html>
