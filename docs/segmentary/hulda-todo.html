<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"><!-- for emoji happiness-->
    <link rel='stylesheet'
        href='https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/css/calcite-web.min.css'>

    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.0-beta.76/calcite.esm.js"></script>
    <script nomodule="" src="https://js.arcgis.com/calcite-components/1.0.0-beta.76/calcite.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.0-beta.76/calcite.css" />

    <link href="https://unpkg.com/tabulator-tables@5.1/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.1/dist/js/tabulator.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body {
            padding: 1em;
        }

        calcite-button {
            padding: 0.15em
        }
    </style>
</head>

<body>
    <h1>Hulda Segments To Run</h1>

    <div id="personalButtons">Segments left to run for:
    </div>
    <div id="multiPersonButtons">Segments left to run for both:
    </div>
    <div id="butnotbuttons">Segments left to run for ... but already run by ...
    </div>

    <div id="description" style="padding-top:1em"></div>

    <ol id="segmentListing">
    </ol>

    <hr>
    <p id="intro">
        Map coming soon-ish...
    </p>
    <hr>
    <footer>Note that you can add anyone's strava athlete id to get the URL parameter (as shown be the button examples
        above).</footer>
    <script>
        (async () => {

            const descriptionDiv = document.getElementById('description');
            const segmentListingElement = document.getElementById('segmentListing');
            const areaname = "Hulda";

            const segmURL = areaname.toLocaleLowerCase() + "-segments.json"
            const athlURL = areaname.toLocaleLowerCase() + "-athletes.json"
            let segmentData = [];
            let athleteData = [];

            const href = window.location.href;
            const pageURL = new URL(href);
            const initialRunner = pageURL.searchParams.get("runner") || "1167695";
            const initialRunners = pageURL.searchParams.get("runners") || false;

            const runnerButtons =
            {
                'Bjorn': '1167695',
                'Chris': '294207',
                'Erwin': '16638771',
                'Kylie': '6260742',
                'Zara': '23099564'
            };

            const personalButtonsDiv = document.getElementById('personalButtons');
            const multiPersonButtonsDiv = document.getElementById('multiPersonButtons');
            const butnotbuttonsDiv = document.getElementById('butnotbuttons');

            for (const runnerName in runnerButtons) {
                let cb = document.createElement("calcite-button")
                cb.id = runnerButtons[runnerName];
                cb.innerHTML = runnerName;
                personalButtonsDiv.append(cb)
                cb.addEventListener("click", function () {
                    personalSegmentsTodo(runnerButtons[runnerName]);
                });
                if (runnerName != "Bjorn") {
                    let cb = document.createElement("calcite-button")
                    cb.id = runnerButtons["Bjorn"] + "--" + runnerButtons[runnerName];
                    cb.innerHTML = "Bjorn & " + runnerName;
                    multiPersonButtonsDiv.append(cb)
                    cb.addEventListener("click", function () {
                        getCommonSegmentsTodo(runnerButtons["Bjorn"], runnerButtons[runnerName]);
                    });
                }
            }
            // the two BUTNOT buttons
            let cb1 = document.createElement("calcite-button");
            let cb2 = document.createElement("calcite-button");
            cb1.id = runnerButtons["Bjorn"] + "--butnot--" + runnerButtons["Kylie"];
            cb2.id = runnerButtons["Kylie"] + "--butnot--" + runnerButtons["Bjorn"];
            cb1.innerHTML = "Bjorn but not Kylie";
            cb2.innerHTML = "Kylie but not Bjorn";
            butnotbuttonsDiv.append(cb1);
            butnotbuttonsDiv.append(cb2);
            cb1.addEventListener("click", function () {
                getUniqueSegmentsTodo(runnerButtons["Bjorn"], runnerButtons["Kylie"]);
            });
            cb2.addEventListener("click", function () {
                getUniqueSegmentsTodo(runnerButtons["Kylie"], runnerButtons["Bjorn"]);
            });

            // grab the available HTML file names
            await axios.get(segmURL)
                .then(function (response) {
                    segmentData = response.data; // .body ; //JSON.parse(response.body);
                    segmentData.forEach((element, index) => {
                        if (element.name.match(/&#39;/)) {
                            element.name = element.name.replace(/&#39;/gi, "'");
                        }
                    });
                })
                .catch(function (error) {
                    console.error("-------- error 101 ----------");
                    console.error(error);
                })
                .then(function () {
                    console.log(`~~~~~~~~~~~~~~~~ got data for ${segmentData.length} segments.`)
                    segmentData.sort((a, b) => {
                        return a['peopleCount'] - b['peopleCount'];  // highest first
                    });

                });
            // end of axiom

            await axios.get(athlURL)
                .then(function (response) {
                    athleteData = response.data;
                    athleteData.forEach((element, index) => {
                        if (element.name.match(/&#39;/)) {
                            element.name = element.name.replace(/&#39;/gi, "'");
                        }
                    });
                })
                .catch(function (error) {
                    console.error("-------- error 102 ----------");
                    console.error(error);
                })
                .then(function () {
                    console.log(`~~~~~~~~~~~~~~~~ got data for ${athleteData.length} athletes.`);
                });
            // end of axiom

            function personalSegmentsTodo(runner) {
                let segmentsLeft = segmentData.filter(seg => !seg.athletes.includes(runner))
                let thatTarget = document.getElementById(runner);

                if (thatTarget) {
                    let runnerName;
                    for (const [key, value] of Object.entries(runnerButtons)) {
                        if (value == runner) {
                            runnerName = key
                        }
                    }
                    thatTarget.innerHTML = `${runnerName} (${segmentsLeft.length})`
                }

                descriptionDiv.innerHTML = `${segmentsLeft.length} segments that <a href="https://www.strava.com/athletes/{${runner}">${athleteData.find(element => element.id == runner).name}</a>
                 have not yet run in <b>${areaname}</b> area:`;

                document.getElementById("segmentListing").innerHTML = "";
                for (var i = 0; i < segmentsLeft.length; i++) {
                    const fact = `<a href="https://www.strava.com/segments/${segmentsLeft[i].segment}">${segmentsLeft[i].name}</a>
                    -- ${segmentsLeft[i].distance} miles long, ran by ${segmentsLeft[i].peopleCount} other runners.`;
                    const newDiv2 = document.createElement("li");
                    newDiv2.innerHTML = fact;
                    segmentListingElement.prepend(newDiv2);
                }
                // This will create a new entry in the browser's history, without reloading
                window.history.pushState({}, '', `?runner=${runner}`);
            } // end of personalSegmentsTodo

            function getUniqueSegmentsTodo(runner1, runner2) {
                document.getElementById("segmentListing").innerHTML = "";
                const segmentsLeft = segmentData.filter(seg => !seg.athletes.includes(runner1) && seg.athletes.includes(runner2))
                let thatTarget = document.getElementById(runner1 + '--butnot--' + runner2);

                if (thatTarget) {
                    let runnerName1, runnerName2;
                    for (const [key, value] of Object.entries(runnerButtons)) {
                        if (value == runner1) {
                            runnerName1 = key;
                        } else if (value == runner2) {
                            runnerName2 = key;
                        }

                    }
                    thatTarget.innerHTML = `${runnerName1} but not ${runnerName2} (${segmentsLeft.length})`
                }

                descriptionDiv.innerHTML = `<a href="https://www.strava.com/athletes/{${runner1}">${athleteData.find(element => element.id == runner1).name}</a>
                has ${segmentsLeft.length} segments left to run, that <a href="https://www.strava.com/athletes/{${runner2}">${athleteData.find(element => element.id == runner2).name}</a> have already run.`;
                for (var i = 0; i < segmentsLeft.length; i++) {
                    const fact = `<a href="https://www.strava.com/segments/${segmentsLeft[i].segment}">${segmentsLeft[i].name}</a>
                    -- ${segmentsLeft[i].distance} miles long, ran by ${segmentsLeft[i].peopleCount} other runners.`;
                    const newDiv2 = document.createElement("li");
                    newDiv2.innerHTML = fact;
                    segmentListingElement.prepend(newDiv2);
                }
                window.history.pushState({}, '', `?runners=${runner1}|${runner2}`);
            }

            function getCommonSegmentsTodo(runner1, runner2) {
                document.getElementById("segmentListing").innerHTML = "";
                const commonSegmentsLeft = segmentData.filter(seg => !seg.athletes.includes(runner1) && !seg.athletes.includes(runner2))
                let thatTarget = document.getElementById(runner1 + '--' + runner2);

                if (thatTarget) {
                    let runnerName1, runnerName2;
                    for (const [key, value] of Object.entries(runnerButtons)) {
                        if (value == runner1) {
                            runnerName1 = key;
                        } else if (value == runner2) {
                            runnerName2 = key;
                        }

                    }
                    thatTarget.innerHTML = `${runnerName1} & ${runnerName2} (${commonSegmentsLeft.length})`
                }

                descriptionDiv.innerHTML = `Comparing <a href="https://www.strava.com/athletes/{${runner1}">${athleteData.find(element => element.id == runner1).name}</a>
                and <a href="https://www.strava.com/athletes/{${runner2}">${athleteData.find(element => element.id == runner2).name}</a> in <b>${areaname}</b> area.
                <br><br>There are ${commonSegmentsLeft.length} segments that neither have run:`;
                for (var i = 0; i < commonSegmentsLeft.length; i++) {
                    const fact = `<a href="https://www.strava.com/segments/${commonSegmentsLeft[i].segment}">${commonSegmentsLeft[i].name}</a>
                    -- ${commonSegmentsLeft[i].distance} miles long, ran by ${commonSegmentsLeft[i].peopleCount} other runners.`;
                    const newDiv2 = document.createElement("li");
                    newDiv2.innerHTML = fact;
                    segmentListingElement.prepend(newDiv2);
                }
                // This will create a new entry in the browser's history, without reloading
                window.history.pushState({}, '', `?runners=${runner1},${runner2}`);
            } // end of getCommonSegmentsTodo

            // everything setup, time to run something
            if (initialRunners && initialRunners.match(/,/)) {
                let [runnerId1, runnerId2] = initialRunners.split(',');
                getCommonSegmentsTodo(runnerId1, runnerId2);
            } else if (initialRunners && initialRunners.match(/|/)) {
                let [runnerId1, runnerId2] = initialRunners.split('|');
                getUniqueSegmentsTodo(runnerId1, runnerId2);
            } else {
                personalSegmentsTodo(initialRunner);
            }
        })(); // end main async
    </script>
</body>

</html>